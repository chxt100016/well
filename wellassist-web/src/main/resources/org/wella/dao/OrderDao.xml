<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.wella.dao.OrderDao">

    <resultMap id="order" type="org.wella.entity.Order">
        <id column="order_id" property="orderId"/>
        <result column="order_no" property="orderNo"/>
        <result column="prod_id" property="prodId"/>
        <result column="prod_name" property="prodName"/>
        <result column="from_region_id" property="fromRegionId"/>

        <result column="from_region_addr" property="fromRegionAddr"/>
        <result column="to_region_id" property="toRegionId"/>
        <result column="to_region_addr" property="toRegionAddr"/>
        <result column="user_id" property="userId"/>
        <result column="user_lxr" property="userLxr"/>

        <result column="to_region_id" property="toRegionId"/>
        <result column="user_lxr_phone" property="userLxrPhone"/>
        <result column="supplier_id" property="supplierId"/>
        <result column="sale_num" property="saleNum"/>
        <result column="sale_money" property="saleMoney"/>

        <result column="order_date" property="orderDate"/>
        <result column="order_ip" property="orderIp"/>
        <result column="is_self_car" property="isSelfCar"/>
        <result column="confirm_number" property="confirmNumber"/>
        <result column="confirm_price" property="confirmPrice"/>

        <result column="order_date" property="orderDate"/>
        <result column="order_ip" property="orderIp"/>
        <result column="is_self_car" property="isSelfCar"/>
        <result column="confirm_number" property="confirmNumber"/>
        <result column="confirm_price" property="confirmPrice"/>

        <result column="pj_state" property="pjState"/>
        <result column="pj_date" property="pjDate"/>
        <result column="pj_content" property="pjContent"/>
        <result column="kp_complete_date" property="kpCompleteDate"/>
        <result column="kp_state" property="kpState"/>

        <result column="dj_modify_date" property="djModifyDate"/>
        <result column="sale_sj_num" property="saleSjNum"/>
        <result column="sale_sj_money" property="saleSjMoney"/>
        <result column="sq_money" property="sqMoney"/>
        <result column="order_type" property="orderType"/>

    </resultMap>

	<insert id="createOrder" useGeneratedKeys="true" keyProperty="orderId" parameterType="org.wella.entity.Order">
        insert into wa_order (order_no, prod_id,
          prod_name, from_region_id, from_region_addr,
          to_region_id, to_region_addr, user_id,
          company_lxr, company_lxr_phone, supplier_id,
          sale_num, sale_money, dj_modify_date,
          sale_sj_num, sale_sj_money, sq_money,
          order_state, order_type, order_date,
          order_ip, kp_state, kp_complete_date,
          is_self_car, pj_state, pj_date,
          pj_content, confirm_price, confirm_number,
          customer_except_carriage)
        values ( #{orderNo,jdbcType=VARCHAR}, #{prodId,jdbcType=BIGINT},
          #{prodName,jdbcType=VARCHAR}, #{fromRegionId,jdbcType=BIGINT}, #{fromRegionAddr,jdbcType=VARCHAR},
          #{toRegionId,jdbcType=BIGINT}, #{toRegionAddr,jdbcType=VARCHAR}, #{userId,jdbcType=BIGINT},
          #{companyLxr,jdbcType=VARCHAR}, #{companyLxrPhone,jdbcType=VARCHAR}, #{supplierId,jdbcType=BIGINT},
          #{saleNum,jdbcType=DECIMAL}, #{saleMoney,jdbcType=DECIMAL}, #{djModifyDate,jdbcType=TIMESTAMP},
          #{saleSjNum,jdbcType=DECIMAL}, #{saleSjMoney,jdbcType=DECIMAL}, #{sqMoney,jdbcType=DECIMAL},
          #{orderState,jdbcType=TINYINT}, #{orderType,jdbcType=TINYINT}, #{orderDate,jdbcType=TIMESTAMP},
          #{orderIp,jdbcType=VARCHAR}, #{kpState,jdbcType=TINYINT}, #{kpCompleteDate,jdbcType=TIMESTAMP},
          #{isSelfCar,jdbcType=TINYINT}, #{pjState,jdbcType=TINYINT}, #{pjDate,jdbcType=TIMESTAMP},
          #{pjContent,jdbcType=VARCHAR}, #{confirmPrice,jdbcType=DECIMAL}, #{confirmNumber,jdbcType=DECIMAL},
          #{customerExceptCarriage,jdbcType=DECIMAL});
	</insert>

    <!--根据订单id更新订单，在卖家确认时，支付时等情况对其进行操作-->
    <update id="updateOrderByID" parameterType="map">
        UPDATE  wa_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="confirmPrice != null">confirm_price = #{confirmPrice},</if>
            <if test="confirmNumber != null">confirm_number = #{confirmNumber},</if>
            <if test="saleSjNum != null">sale_sj_num = #{saleSjNum},</if>
            <if test="saleSjMoney != null">sale_sj_money = #{saleSjMoney},</if>
            <if test="pjState != null">pj_state = #{pjState},</if>
            <if test="pjDate != null">pj_date = #{pjDate},</if>
            <if test="pjContent != null">pj_content = #{pj_Content},</if>
            <if test="orderState != null">order_state = #{orderState},</if>
            <if test="djModifyDate != null">dj_modify_date = #{djModifyDate}</if>
        </trim>
        where order_id = #{orderId}
    </update>

    <select id="findOrder" parameterType="map" resultMap="order">
        SELECT *
        FROM wa_order
        WHERE 1 = 1
        <if test="orderId != null">
            AND order_id LIKE '%${orderId}%'
        </if>
        <if test="orderNo != null">
            AND order_no LIKE '%${orderNo}%'
        </if>
        <if test="prodName != null">
            AND prod_name LIKE '%${prodName}%'
        </if>

    </select>

    <!-- 获取买家订单列表 -->
    <select id="findCustomerOrderList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT a.order_id, a.order_no, a.prod_id, a.sale_num, a.sale_money, a.sale_sj_num, a.sale_sj_money, a.order_state, DATE(a.order_date) as order_date, a.is_self_car, b.prod_name, b.prod_img
        FROM wa_order as a INNER JOIN wa_prod as b ON a.prod_id = b.prod_id
        WHERE a.user_id = #{userId}
        <if test="orderState!=null and orderState!=''">
            AND a.order_state = #{orderState}
        </if>
        ORDER BY a.order_id DESC
        LIMIT ${start} , ${size}
    </select>

    <!-- 获取买家订单列表总数 -->
    <select id="findCustomerOrderListCount" parameterType="java.util.Map" resultType="int">
        SELECT count(*)
        FROM wa_order as a INNER JOIN wa_prod as b ON a.prod_id = b.prod_id
        WHERE a.user_id = #{userId}
        <if test="orderState!=null and orderState!=''">
            AND a.order_state = #{orderState}
        </if>
    </select>
    
    <select id="listOrderAttachProd" parameterType="map" resultType="map">
        SELECT *,c.`prod_price`,(c.`prod_num`-c.`sale_num`) prod_num
        FROM wa_order a INNER JOIN wa_prod c
        ON a.`prod_id`=c.`prod_id`
        WHERE a.`supplier_id`=${supplierId}
        AND a.order_state > -1
        <if test="orderState != null">
            AND a.order_state=${orderState}
        </if>
        ORDER BY a.`user_id`
        <if test="start != null and size != null">
            LIMIT ${start},${size}
        </if>
    </select>

    <select id="listOrderCount" parameterType="map" resultType="int">
        SELECT count(*)
        from wa_order
        <where>
            <if test="supplierId != null">
                AND `supplier_id`=${supplierId}
            </if>
            <if test="orderState != null">
                AND a.order_state=${orderState}
            </if>
        </where>
    </select>
</mapper>